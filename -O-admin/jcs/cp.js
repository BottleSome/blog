/*ControlPosts4.5.0 - SomeBottle20211021*/
"use strict";var mark=function(a){return window.markdownit({html:!0,linkify:!0}).use(window.markdownItAnchor,{permalink:window.markdownItAnchor.permalink.linkInsideHeader({symbol:"#",placement:"before"})}).render(a)},editpost="none",tpjs=JSON.parse(window.tjson);renderlist(),loadhide();var timer,choose=0;function rmj(){var a=Math.random().toString(36).substr(5);return"main."+a+".json"}function getdate(){var a=new Date,b=a.getMonth()+1,c=a.getDate();return 1<=b&&9>=b&&(b="0"+b),1<=c&&9>=c&&(c="0"+c),a.getFullYear()+b.toString()+c.toString()}var B={r:function(b,c,d,e=!1,f=!0){if(b){if(e)return"("==e?b.replace(new RegExp("\\{\\("+c+"\\)\\}",(f?"g":"")+"i"),d):b.replace(new RegExp("\\{\\["+c+"\\]\\}",(f?"g":"")+"i"),d);if(f)for(;-1!==b.indexOf(c);)b=b.replace(c,d);else b=b.replace(c,d)}return b},gt:function(a,b,c=!1,f=!1){var g=c?c:document.getElementsByTagName("html")[0].innerHTML;try{var e=f?g.split(a)[1]:g.split(new RegExp("\\{\\("+a+"\\)\\}","i"))[1],h=f?e.split(b)[0]:e.split(new RegExp("\\{\\("+b+"\\)\\}","i"))[0];return h}catch(a){return!1}}};function renderlist(){var a=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),b="",c=0;for(var d in a.dateindex){if(c>=8)break;var e=parseInt(d.replace("post","")),f=Base64.decode(a.postindex[e].title);b+="<p class='postitemp'><a class='postitema' href='javascript:void(0);' onclick='postopen("+e+")'>"+f+"</a></p>",c+=1}""==b&&(b+="<p class='postitemp'><a class='postitema' href='javascript:void(0);'>\u8FD8\u6CA1\u6709\u6587\u7AE0\u5462</a></p>"),SC("rp").innerHTML=b}function eswitch(){choose+=1,8<=choose&&(choose=8),SC("fbtn").style.backgroundColor=5==choose?"#FA5858":"#0080ff";SC("fbtn").innerHTML=["\u7F16\u8F91/\u53D1\u5E03","\u9884\u89C8","\u4FDD\u5B58\u8349\u7A3F","\u8BFB\u53D6\u8349\u7A3F","\u5220\u9664","\u9884\u89C8\u524D\u7F6E","\u751F\u6210\u5F52\u6863","\u53D6\u6D88"][choose-1],clearTimeout(timer),timer=setTimeout(function(){1===choose?(edit(),console.log("\u7F16\u8F91/\u53D1\u5E03")):2===choose?(console.log("\u9884\u89C8"),preview()):3===choose?(console.log("\u4FDD\u5B58\u8349\u7A3F"),tempsave()):4===choose?(console.log("\u8BFB\u53D6\u8349\u7A3F"),readsave()):5===choose?(console.log("\u5220\u9664"),"none"==editpost?notice("\u73B0\u5728\u6CA1\u6709\u7F16\u8F91\u4EFB\u4F55\u6587\u7AE0"):confirm("\u771F\u7684\u8981\u5220\u9664\u5F53\u524D\u6587\u7AE0\u5417\uFF1F\uFF01")&&delpost(editpost)):6===choose?(console.log("\u9884\u89C8\u524D\u7F6E"),beforePreviewHtml()):7===choose?(console.log("\u751F\u6210\u5F52\u6863"),tagarchive()):8===choose?console.log("\u53D6\u6D88"):void 0;SC("fbtn").innerHTML="O_o?",SC("fbtn").style.backgroundColor="#0080ff",choose=0},1e3)}function scriptcutter(a){var b=document.createElement("div");b.innerHTML=a;var c=b.getElementsByTagName("script");for(var d in c){var e=c[d].innerHTML;if(e!==void 0){e=B.r(e,"/*",""),e=B.r(e,"*/","");let a="/*"+e+"*/";c[d].innerHTML=a}}var f=b.innerHTML;return f}function beforePreviewHtml(){localStorage.OBeforePreview=localStorage.OBeforePreview||"";let a=prompt("\u8BF7\u8F93\u5165\u4F60\u5728\u9884\u89C8body\u90E8\u5206\u4E2D\u8981\u63D2\u5165\u7684\u524D\u7F6Ehtml\n\uFF08\u7528\u4E8E\u6587\u7AE0\u4E2D\u9700\u8981\u5916\u90E8js\u5E93\u7684\u811A\u672C\u9884\u89C8)",localStorage.OBeforePreview);localStorage.OBeforePreview=a}function enhtml(a){var b=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return b}function dehtml(a){var b=a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#039;/g,"'").replace(/&quot;/g,"\"");return b}function tagarchive(){var a=tpjs.templatehtmls.tags,b=tpjs.templatehtmls.archives,c=tpjs.generatehtmls.tags,d=tpjs.generatehtmls.archives,e=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),f=window.htmls["index.html"],g=B.r(f,"title","Tags",!0);g=B.r(g,"titlemiddle","-",!0);var h=B.r(g,"sitename",e.name,!0),i=B.r(h,"keywords",e.name+",tag",!0),j=B.r(i,"description","Tag Page",!0),k=B.r(j,"type",a,!0),l=B.r(f,"title","Archives",!0);l=B.r(l,"titlemiddle","-",!0);var m=B.r(l,"sitename",e.name,!0),n=B.r(m,"keywords",e.name+",archive",!0),o=B.r(n,"description","Archive Page",!0),p=B.r(o,"type",b,!0);confirm("\u786E\u5B9A\u8981\u751F\u6210\u6807\u7B7E\u548C\u5F52\u6863\u9875\u9762\uFF1F")&&(loadshow(),new Promise(a=>{blog.cr(window.accesstoken,window.githubrepo,k,{success:b=>{let d=[];d.push({path:c,mode:"100644",type:"blob",sha:b.sha}),a(d)},failed:()=>{notice("\u751F\u6210\u5931\u8D25",!0),loadhide()}})}).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,p,{success:c=>{a.push({path:d,mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u751F\u6210\u5931\u8D25",!0),loadhide()}})})).then(a=>{blog.gpush(window.accesstoken,window.githubrepo,a,"Add Archives Page and Tags Page",{success:()=>{notice("\u751F\u6210\u6210\u529F"),loadhide()},failed:()=>{notice("\u751F\u6210push\u5931\u8D25",!0),loadhide()}})}))}function covercutter(a){for(var b=a;-1!==b.indexOf("<ifcover>");){var c=B.gt("<ifcover>","</ifcover>",b,!0);b=B.r(b,"<ifcover>"+c+"</ifcover>","")}return b}function transdate(a){let b=a+"",c=b.slice(-4),e=c.slice(-2),d=c.substring(0,2),f=b.replace(c,"");return f+"-"+d+"-"+e}function indexrenderer(a){var b=tpjs.templatehtmls.postlist,c=a,d=window.htmls["index.html"],e=window.htmls["postitem.html"];e=B.gt("PostItem","PostItemEnd",e);var f=c.dateindex,g="",h=parseInt(c.posts_per_page),j=0;for(var k in f)if(j<h){var i=k.replace("post",""),l=c.postindex[i];if(!l.link){var m=B.r(e,"postitemtitle",Base64.decode(l.title),!0),n=B.r(m,"postitemintro",Base64.decode(l.intro)+"...",!0),o=B.r(n,"postitemdate",transdate(l.date),!0),p=B.r(o,"postitemtags",l.tags.replace(/,/g,"\xB7"),!0),q=B.r(p,"postitemlink","post-"+i+".html",!0);q=l.cover?B.r(q,"postcover",l.cover,!0):covercutter(q),g+=q}else j-=1;j+=1}else break;var r=B.r(d,"title","",!0);r=B.r(r,"titlemiddle","",!0);var s=B.r(r,"description","",!0),t=B.r(s,"keywords",c.name,!0),u=B.r(t,"type",b,!0),v=B.r(u,"sitename",c.name,!0),w=B.r(v,"content",enhtml(g),!0);return w}function tempsave(){function a(a,b){var c=localStorage[a]||"[]",d=JSON.parse(c),e={};e.v=b,e.t=new Date,10<=d.length&&d.shift(),d.push(e),localStorage[a]=JSON.stringify(d)}var b=SC("title").value,c=SC("date").value,d=SC("tag").value,e=SC("content").value;a("otitle",b),a("odate",c),a("otag",d),a("ocontent",e),notice("\u4FDD\u5B58\u6210\u529F")}function readsave(){function a(a,b=!1){var c=localStorage[a]||"[]",d=JSON.parse(c);return 0<=parseInt(b)?d[b]||!1:d}var b="",c=a("otitle");for(var d in c)b+="\u5E8F\u53F7:"+d+" \u4FDD\u5B58\u65F6\u95F4:"+c[d].t+"\n";var e=parseInt(prompt("\u8BF7\u8F93\u5165\u8981\u8BFB\u53D6\u7684\u8349\u7A3F\u5E8F\u53F7\n"+b+"\n\n\u8FD9\u4F1A\u8986\u76D6\u4F60\u76EE\u524D\u7684\u5185\u5BB9","")),f=a("otitle",e);f&&0<=e?(SC("title").value=f.v,SC("date").value=a("odate",e).v,SC("tag").value=a("otag",e).v,SC("content").value=a("ocontent",e).v):notice("\u65E0\u6B64\u8349\u7A3F")}function preview(){var a=SC("content").value,b=B.r(a,"/*","");b=B.r(b,"*/","");var c=window.open("");c.opener=null,c.document.write(`<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1"><link href='https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown-light.css' rel="stylesheet" /></head><body>${localStorage.OBeforePreview||""}<div class='markdown-body'>${mark(b)}</div></body>`),c.document.close()}function coverdrawer(){return B.gt("-[cover:","]-",SC("content").value,!0)}function edit(){window.editprogress="doing";var a=tpjs.templatehtmls.post,b=SC("title").value;if(b.match(/^[ ]+$/)||""==b)return notice("\u6807\u9898\u4E0D\u80FD\u4E3A\u7A7A\u54E6"),!1;var c=SC("date").value;(c.match(/^[ ]+$/)||""==c)&&(c=getdate());var e=SC("tag").value,f=scriptcutter(SC("content").value),g=!1;if(isNaN(c)){if(g=!0,-1!==tpjs.alltp.indexOf(c+".html"))return notice("\u94FE\u63A5\u540D\u4E0E\u6A21\u677F\u91CD\u590D\uFF01"),notice("\u8BF7\u66F4\u6362"),!1;e=""}var h=mark(f).replace(/<\/?.+?>/g,"").substring(0,100).replace(/[ ]/g,"").replace(/[\r\n]/g,"");if(70<=f.length&&(h+="..."),confirm("\u771F\u7684\u8981\u53D1\u5E03\u561B\uFF1F")){var j=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),k=window.htmls["index.html"],l=B.r(k,"title",b,!0);l=B.r(l,"titlemiddle","-",!0);var m=B.r(l,"date",c,!0),n=B.r(m,"tags",e,!0),o=B.r(n,"content",enhtml(f),!0),p=B.r(o,"description",h.replace(/<\/?.+?>/g,""),!0),q=B.r(p,"keywords",e+","+j.name,!0),r=B.r(q,"type",a,!0),s=B.r(r,"sitename",j.name,!0);"initialized"==j[0]&&delete j[0],j.postnum||(j.postnum=0),j.postindex||(j.postindex={}),j.dateindex&&"object"==typeof j.dateindex||(j.dateindex={});var t=j.postnum,u="New post";"none"===editpost?j.postnum+=1:(t=editpost,u="Edit post");var v=B.r(s,"pid",t,!0),w="";g&&(w=c,c=getdate()),j.dateindex["post"+t]=c+t.toString();var x=0;for(var y in j.dateindex){var z=j.dateindex[y].toString().length;z>x&&(x=z)}for(var y in j.dateindex){var A=j.dateindex[y],z=A.toString().length;if(z<x){for(var C=y.replace("post","").toString(),D=x-z,E=0,F="";E<D;)F+=0 .toString(),E+=1;var G=getdate().toString().length,H=A.toString().substring(0,G),I=A.toString().substring(z-C.length),J=I.toString().replace(C,F+C);j.dateindex[y]=parseInt(H+J)}}var K=[];for(var L in j.dateindex)K.push([L,parseInt(j.dateindex[L])]);for(var M in j.dateindex={},K=K.sort(function(c,a){return c[1]-a[1]}).reverse(),window.testarray=K,K){var d=K[M];j.dateindex[d[0]]=d[1]}var N="";if("none"!==editpost&&!g&&j.postindex[t].link)return notice("\u4F60\u6B63\u5728\u7F16\u8F91\u9875\u9762"),notice("\u4E0D\u80FD\u8F6C\u4E3A\u6587\u7AE0"),!1;if("none"!==editpost&&g&&(N=j.postindex[t].link,!N))return notice("\u4F60\u6B63\u5728\u7F16\u8F91\u6587\u7AE0"),notice("\u4E0D\u80FD\u8F6C\u4E3A\u9875\u9762"),!1;j.postindex[t]={},j.postindex[t].title=Base64.encode(b),j.postindex[t].date=c;var O=coverdrawer();if(O){j.postindex[t].cover=O;var P="";"none"==O&&j.postindex[t].cover&&(delete j.postindex[t].cover,P=""),v=B.r(v,"cover",O,!0)}else v=B.r(v,"cover","none",!0);g&&(j.postindex[t].link=w),j.postindex[t].intro=Base64.encode(h),j.postindex[t].tags=e,loadshow();var Q="post-"+t+".html";g&&(Q=w+".html");var R=indexrenderer(j),S=tpjs.mainjson;tpjs.mainjson=rmj(),new Promise(a=>{blog.cr(window.accesstoken,window.githubrepo,v,{success:b=>{let c=[];c.push({path:Q,mode:"100644",type:"blob",sha:b.sha}),a(c)},failed:()=>{notice("\u7F16\u8F91/\u53D1\u5E03\u5931\u8D25",!0),loadhide()}})}).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(j),{success:c=>{a.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u7D22\u5F15\u4E0A\u8F7D\u5931\u8D25",!0),loadhide()}})})).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,R,{success:c=>{a.push({path:"index.html",mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u9996\u9875\u66F4\u65B0\u5931\u8D25",!0),loadhide()}})})).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:c=>{a.push({path:"template.json",mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u6A21\u677F\u7D22\u5F15\u66F4\u65B0\u5931\u8D25",!0),loadhide()}})})).then(a=>(a.push({path:S,mode:"160000",type:"commit",sha:null}),""!==N&&N!==w&&a.push({path:N+".html",mode:"160000",type:"commit",sha:null}),new Promise(b=>{blog.gpush(window.accesstoken,window.githubrepo,a,u,{success:a=>{b(JSON.parse(a))},failed:()=>{notice("\u66F4\u65B0push\u5931\u8D25",!0),loadhide()}})}))).then(a=>{blog.getfileshas(window.accesstoken,window.githubrepo,!0,{success:a=>{window.fileshas=a,window.editprogress="finish",window.mainjson.content=Base64.encode(JSON.stringify(j)),window.tjson=JSON.stringify(tpjs)},failed:()=>{notice("\u5237\u65B0\u4E34\u65F6\u6587\u4EF6sha\u5217\u8868\u5931\u8D25",!0),loadhide()}},a.object.sha)});var T=setInterval(function(){"finish"==window.editprogress&&(window.gstate=0,window.editprogress="",notice("\u7F16\u8F91/\u53D1\u5E03\u6210\u529F"),renderlist(),"none"===editpost?postopen(t):window.htmls[g?w+".html":"post-"+editpost+".html"]=Base64.encode(v),loadhide(),clearInterval(T))},1500)}}function delpost(a){var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,"")));if(b.postindex[a]){var c=b.postindex[a],d=c.date,e=!1;c.link&&(e=!0),delete b.postindex[a],delete b.dateindex["post"+a],loadshow();var f="post-"+a+".html";e&&(f=c.link+".html");var g=indexrenderer(b),h=tpjs.mainjson;tpjs.mainjson=rmj(),new Promise(a=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(b),{success:b=>{let c=[];c.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:b.sha}),a(c)},failed:()=>{notice("\u66F4\u65B0\u7D22\u5F15\u5931\u8D25",!0),loadhide()}})}).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:c=>{a.push({path:"template.json",mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u66F4\u65B0\u7D22\u5F15\u6A21\u677F\u5931\u8D25",!0),loadhide()}})})).then(a=>new Promise(b=>{blog.cr(window.accesstoken,window.githubrepo,g,{success:c=>{a.push({path:"index.html",mode:"100644",type:"blob",sha:c.sha}),b(a)},failed:()=>{notice("\u9996\u9875\u66F4\u65B0\u5931\u8D25",!0),loadhide()}})})).then(a=>{a.push({path:f,mode:"160000",type:"commit",sha:null}),a.push({path:h,mode:"160000",type:"commit",sha:null}),blog.gpush(window.accesstoken,window.githubrepo,a,"Delete post/page",{success:()=>{window.mainjson.content=Base64.encode(JSON.stringify(b)),window.tjson=JSON.stringify(tpjs),renderlist(),notice("\u5220\u9664\u6210\u529F"),loadhide()},failed:()=>{notice("\u5220\u9664:\u66F4\u65B0push\u5931\u8D25",!0),loadhide()}})})}}function postopen(a){loadshow();var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),c=!1;b.postindex[a].link&&(c=!0);let d=function(d){loadhide();var e=Base64.decode(d),f=Base64.decode(b.postindex[a].title);if(c)var g=b.postindex[a].link;else var g=b.postindex[a].date;var h=b.postindex[a].tags,i=B.gt("PostContent","PostContentEnd",e).trim();SC("content").value=dehtml(i),SC("tag").value=h,SC("title").value=f,SC("date").value=g,addshow(),editpost=a};var e="post-"+a+".html";if(c&&(e=b.postindex[a].link+".html"),!window.htmls[e]){this;blog.getfileblob(window.accesstoken,window.githubrepo,blog.findfilesha(e),!0,{success:function(a){d(a.content),window.htmls[e]=a.content},failed:function(){loadhide(),notice("\u52A0\u8F7D\u6587\u7AE0\u5931\u8D25"),notice("No such post.")}})}else d(window.htmls[e])}function addnew(){addhide(),editpost="none",SC("content").value="",SC("tag").value="",SC("title").value="",SC("date").value=""}document.onkeydown=function(a){var b=a||window.event;if(b&&13==b.keyCode){var c=SC("search").value;if(""!==c&&SC("search")==document.activeElement)SC("sbr").style.zIndex=50,SC("sbr").style.opacity=1,SC("sbr").innerHTML="<p class='scitemp'><a class='scitema' href='#Searching..'>\u641C\u7D22\u4E2D...</a></p>",searchrender(c);else return!0}else return!0};function searchrender(a){var b="",c=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),d=c.postindex;for(var e in d){var f=Base64.decode(d[e].title).toLowerCase(),g=Base64.decode(d[e].intro).toLowerCase(),h=d[e].date.toLowerCase(),i=d[e].tags.toLowerCase();a=a.toLowerCase(),(-1!==f.indexOf(a)||-1!==g.indexOf(a)||-1!==h.indexOf(a)||-1!==i.indexOf(a))&&(b+="<p class='scitemp'><a class='scitema' href='javascript:void(0);' onclick='postopen("+e+")'>"+f+"</a></p>")}""==b&&(b+="<h2>\u5565\u90FD\u6CA1\u627E\u5230TAT</h2>"),b="<a class='closebtn' href='javascript:void(0);' onclick='sbrclose()'>\xD7</a>"+b,SC("sbr").innerHTML=b}function sbrclose(){SC("sbr").style.zIndex=-1,SC("sbr").style.opacity=0,SC("sbr").innerHTML=""}function addshow(){SC("adbtn").style.display="block",setTimeout(function(){SC("adbtn").style.opacity=1},100)}function addhide(){SC("adbtn").style.opacity=0,setTimeout(function(){SC("adbtn").style.display="none"},1e3)}SC("date").placeholder=getdate(),document.addEventListener("keydown",function(a){83==a.keyCode&&(navigator.platform.match("Mac")?a.metaKey:a.ctrlKey)&&(a.preventDefault(),tempsave())});