"use strict";var md=new showdown.Converter,editpost="none",tpjs=JSON.parse(window.tjson);renderlist(),loadhide();var timer,choose=0;function rmj(){return"main."+Math.random().toString(36).substr(5)+".json"}function getdate(){var e=new Date,t=e.getMonth()+1,n=e.getDate();return 1<=t&&t<=9&&(t="0"+t),1<=n&&n<=9&&(n="0"+n),e.getFullYear()+t.toString()+n.toString()}var B={r:function(e,t,n,o=!1,i=!0){if(e){if(o)return"("==o?e.replace(new RegExp("\\{\\("+t+"\\)\\}",(i?"g":"")+"i"),n):e.replace(new RegExp("\\{\\["+t+"\\]\\}",(i?"g":"")+"i"),n);if(i)for(;-1!==e.indexOf(t);)e=e.replace(t,n);else e=e.replace(t,n)}return e},gt:function(e,t,n=!1,o=!1){var i=n||document.getElementsByTagName("html")[0].innerHTML;try{var s=(o?i.split(e):i.split(new RegExp("\\{\\("+e+"\\)\\}","i")))[1];return(o?s.split(t):s.split(new RegExp("\\{\\("+t+"\\)\\}","i")))[0]}catch(i){return!1}}};function renderlist(){var e,t=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),n="",o=0;for(e in t.dateindex){if(8<=o)break;var i=parseInt(e.replace("post",""));n+="<p class='postitemp'><a class='postitema' href='javascript:void(0);' onclick='postopen("+i+")'>"+Base64.decode(t.postindex[i].title)+"</a></p>",o+=1}""==n&&(n+="<p class='postitemp'><a class='postitema' href='javascript:void(0);'>还没有文章呢</a></p>"),SC("rp").innerHTML=n}function eswitch(){7<=(choose+=1)&&(choose=7),SC("fbtn").style.backgroundColor=5==choose?"#FA5858":"#0080ff";var e=new Array("编辑/发布","预览","保存草稿","读取草稿","删除","生成归档","取消");SC("fbtn").innerHTML=e[choose-1],clearTimeout(timer),timer=setTimeout(function(){switch(choose){case 1:edit(),console.log("编辑/发布");break;case 2:console.log("预览"),preview();break;case 3:console.log("保存草稿"),tempsave();break;case 4:console.log("读取草稿"),readsave();break;case 5:console.log("删除"),"none"==editpost?notice("现在没有编辑任何文章"):confirm("真的要删除当前文章吗？！")&&delpost(editpost);break;case 6:console.log("生成归档"),tagarchive();break;case 7:console.log("取消")}SC("fbtn").innerHTML="O_o?",SC("fbtn").style.backgroundColor="#0080ff",choose=0},1e3)}function scriptcutter(e){var t=document.createElement("div");t.innerHTML=e;var n,o=t.getElementsByTagName("script");for(n in o){var i=o[n].innerHTML;void 0!==i&&(i=B.r(i,"/*",""),i="/*"+(i=B.r(i,"*/",""))+"*/",o[n].innerHTML=i)}return t.innerHTML}function enhtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function dehtml(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#039;/g,"'").replace(/&quot;/g,'"')}function tagarchive(){var e=tpjs.templatehtmls.tags,t=tpjs.templatehtmls.archives,o=tpjs.generatehtmls.tags,i=tpjs.generatehtmls.archives,n=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),s=window.htmls["index.html"],a=B.r(s,"title","Tags",!0),a=B.r(a,"titlemiddle","-",!0),a=B.r(a,"sitename",n.name,!0),a=B.r(a,"keywords",n.name+",tag",!0),a=B.r(a,"description","Tag Page",!0),r=B.r(a,"type",e,!0),s=B.r(s,"title","Archives",!0),s=B.r(s,"titlemiddle","-",!0),s=B.r(s,"sitename",n.name,!0),n=B.r(s,"keywords",n.name+",archive",!0),n=B.r(n,"description","Archive Page",!0),d=B.r(n,"type",t,!0);confirm("确定要生成标签和归档页面？")&&(loadshow(),new Promise((n,e)=>{blog.cr(window.accesstoken,window.githubrepo,r,{success:e=>{let t=[];t.push({path:o,mode:"100644",type:"blob",sha:e.sha}),n(t)},failed:e=>{notice("生成失败",!0),loadhide()}})}).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,d,{success:e=>{n.push({path:i,mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("生成失败",!0),loadhide()}})})).then(e=>{blog.gpush(window.accesstoken,window.githubrepo,e,"Add Archives Page and Tags Page",{success:e=>{notice("生成成功"),loadhide()},failed:e=>{notice("生成push失败",!0),loadhide()}})}))}function covercutter(e){for(var t=e;-1!==t.indexOf("<ifcover>");)var n=B.gt("<ifcover>","</ifcover>",t,!0),t=B.r(t,"<ifcover>"+n+"</ifcover>","");return t}function transdate(e){var t=String(e),n=t.slice(-4),o=n.slice(-2),e=n.substring(0,2);return t.replace(n,"")+"-"+e+"-"+o}function indexrenderer(e){var t,n=tpjs.templatehtmls.postlist,o=e,i=window.htmls["index.html"],s=window.htmls["postitem.html"],s=B.gt("PostItem","PostItemEnd",s),e=o.dateindex,a="",r=parseInt(o.posts_per_page),d=0;for(t in e){if(!(d<r))break;var c,l=t.replace("post",""),p=o.postindex[l];p.link?--d:(c=B.r(s,"postitemtitle",Base64.decode(p.title),!0),c=B.r(c,"postitemintro",Base64.decode(p.intro)+"...",!0),c=B.r(c,"postitemdate",transdate(p.date),!0),c=B.r(c,"postitemtags",p.tags.replace(/,/g,"·"),!0),l=B.r(c,"postitemlink","post-"+l+".html",!0),a+=l=p.cover?B.r(l,"postcover",p.cover,!0):covercutter(l)),d+=1}i=B.r(i,"title","",!0),i=B.r(i,"titlemiddle","",!0),i=B.r(i,"description","",!0),i=B.r(i,"keywords",o.name,!0),n=B.r(i,"type",n,!0),n=B.r(n,"sitename",o.name,!0);return B.r(n,"content",enhtml(a),!0)}function tempsave(){var e=SC("title").value,t=SC("date").value,n=SC("tag").value,o=SC("content").value;function i(e,t){var n=localStorage[e]||"[]",o=JSON.parse(n),n={};n.v=t,n.t=new Date,10<=o.length&&o.shift(),o.push(n),localStorage[e]=JSON.stringify(o)}i("otitle",e),i("odate",t),i("otag",n),i("ocontent",o),notice("保存成功")}function readsave(){function e(e,t=!1){e=localStorage[e]||"[]",e=JSON.parse(e);return 0<=parseInt(t)?e[t]||!1:e}var t,n="",o=e("otitle");for(t in o)n+="序号:"+t+" 保存时间:"+o[t].t+"\n";var i=parseInt(prompt("请输入要读取的草稿序号\n"+n+"\n\n这会覆盖你目前的内容","")),s=e("otitle",i);s&&0<=i?(SC("title").value=s.v,SC("date").value=e("odate",i).v,SC("tag").value=e("otag",i).v,SC("content").value=e("ocontent",i).v):notice("无此草稿")}function preview(){var e=SC("content").value,t=B.r(e,"/*",""),t=B.r(t,"*/",""),e=window.open("");e.opener=null,e.document.write(md.makeHtml(t)),e.document.close()}function coverdrawer(){return B.gt("-[cover:","]-",SC("content").value,!0)}function edit(){window.editprogress="doing";var e=tpjs.templatehtmls.post,t=SC("title").value;if(t.match(/^[ ]+$/)||""==t)return notice("标题不能为空哦"),!1;var n=SC("date").value;!n.match(/^[ ]+$/)&&""!=n||(n=getdate());var o=SC("tag").value,i=scriptcutter(SC("content").value),s=!1;if(isNaN(n)){if(s=!0,-1!==tpjs.alltp.indexOf(n+".html"))return notice("链接名与模板重复！"),notice("请更换"),!1;o=""}var a=md.makeHtml(i).replace(/<\/?.+?>/g,"").substring(0,100).replace(/[ ]/g,"").replace(/[\r\n]/g,"");if(70<=i.length&&(a+="..."),confirm("真的要发布嘛？")){var r=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),d=window.htmls["index.html"],d=B.r(d,"title",t,!0),d=B.r(d,"titlemiddle","-",!0),d=B.r(d,"date",n,!0),d=B.r(d,"tags",o,!0),i=B.r(d,"content",enhtml(i),!0),i=B.r(i,"description",a.replace(/<\/?.+?>/g,""),!0),i=B.r(i,"keywords",o+","+r.name,!0),e=B.r(i,"type",e,!0),e=B.r(e,"sitename",r.name,!0);"initialized"==r[0]&&delete r[0],r.postnum||(r.postnum=0),r.postindex||(r.postindex=new Object),r.dateindex&&"object"==typeof r.dateindex||(r.dateindex=new Object);var c=r.postnum,l="New post";"none"!==editpost?(c=editpost,l="Edit post"):r.postnum+=1;var p=B.r(e,"pid",c,!0),h="";s&&(h=n,n=getdate()),r.dateindex["post"+c]=n+c.toString();var m,u=0;for(m in r.dateindex)u<(w=r.dateindex[m].toString().length)&&(u=w);for(m in r.dateindex){var w,g=r.dateindex[m];if((w=g.toString().length)<u){for(var v=m.replace("post","").toString(),f=u-w,b=0,S="";b<f;)S+=0..toString(),b+=1;var x=getdate().toString().length,x=g.toString().substring(0,x),v=g.toString().substring(w-v.length).toString().replace(v,S+v);r.dateindex[m]=parseInt(x+v)}}var y,C,j=new Array;for(y in r.dateindex)j.push(Array(y,parseInt(r.dateindex[y])));for(C in r.dateindex=new Object,j=j.sort(function(e,t){return e[1]-t[1]}).reverse(),window.testarray=j){var k=j[C];r.dateindex[k[0]]=k[1]}var O="";if("none"!==editpost&&!s&&r.postindex[c].link)return notice("你正在编辑页面"),notice("不能转为文章"),!1;if("none"!==editpost&&s&&!(O=r.postindex[c].link))return notice("你正在编辑文章"),notice("不能转为页面"),!1;r.postindex[c]=new Object,r.postindex[c].title=Base64.encode(t),r.postindex[c].date=n;n=coverdrawer(),p=n?("none"==(r.postindex[c].cover=n)&&r.postindex[c].cover&&delete r.postindex[c].cover,B.r(p,"cover",n,!0)):B.r(p,"cover","none",!0);s&&(r.postindex[c].link=h),r.postindex[c].intro=Base64.encode(a),r.postindex[c].tags=o,loadshow();var N="post-"+c+".html";s&&(N=h+".html");var T=indexrenderer(r),J=tpjs.mainjson;tpjs.mainjson=rmj(),new Promise((n,e)=>{blog.cr(window.accesstoken,window.githubrepo,p,{success:e=>{let t=[];t.push({path:N,mode:"100644",type:"blob",sha:e.sha}),n(t)},failed:e=>{notice("编辑/发布失败",!0),loadhide()}})}).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(r),{success:e=>{n.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("索引上载失败",!0),loadhide()}})})).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,T,{success:e=>{n.push({path:"index.html",mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("首页更新失败",!0),loadhide()}})})).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:e=>{n.push({path:"template.json",mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("模板索引更新失败",!0),loadhide()}})})).then(n=>(n.push({path:J,mode:"160000",type:"commit",sha:null}),""!==O&&O!==h&&n.push({path:O+".html",mode:"160000",type:"commit",sha:null}),new Promise((t,e)=>{blog.gpush(window.accesstoken,window.githubrepo,n,l,{success:e=>{t(JSON.parse(e))},failed:e=>{notice("更新push失败",!0),loadhide()}})}))).then(e=>{blog.getfileshas(window.accesstoken,window.githubrepo,!0,{success:e=>{window.fileshas=e,window.editprogress="finish",window.mainjson.content=Base64.encode(JSON.stringify(r)),window.tjson=JSON.stringify(tpjs)},failed:e=>{notice("刷新临时文件sha列表失败",!0),loadhide()}},e.object.sha)});var P=setInterval(function(){"finish"==window.editprogress&&(window.gstate=0,window.editprogress="",notice("编辑/发布成功"),renderlist(),"none"!==editpost?window.htmls[s?h+".html":"post-"+editpost+".html"]=Base64.encode(p):postopen(c),loadhide(),clearInterval(P))},1500)}}function delpost(e){var t,n,o,i,s,a=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,"")));a.postindex[e]&&((t=a.postindex[e]).date,n=!1,t.link&&(n=!0),delete a.postindex[e],delete a.dateindex["post"+e],loadshow(),o="post-"+e+".html",n&&(o=t.link+".html"),i=indexrenderer(a),s=tpjs.mainjson,tpjs.mainjson=rmj(),new Promise((n,e)=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(a),{success:e=>{let t=[];t.push({path:tpjs.mainjson,mode:"100644",type:"blob",sha:e.sha}),n(t)},failed:e=>{notice("更新索引失败",!0),loadhide()}})}).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,JSON.stringify(tpjs),{success:e=>{n.push({path:"template.json",mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("更新索引模板失败",!0),loadhide()}})})).then(n=>new Promise((t,e)=>{blog.cr(window.accesstoken,window.githubrepo,i,{success:e=>{n.push({path:"index.html",mode:"100644",type:"blob",sha:e.sha}),t(n)},failed:e=>{notice("首页更新失败",!0),loadhide()}})})).then(e=>{e.push({path:o,mode:"160000",type:"commit",sha:null}),e.push({path:s,mode:"160000",type:"commit",sha:null}),blog.gpush(window.accesstoken,window.githubrepo,e,"Delete post/page",{success:e=>{window.mainjson.content=Base64.encode(JSON.stringify(a)),window.tjson=JSON.stringify(tpjs),renderlist(),notice("删除成功"),loadhide()},failed:e=>{notice("删除:更新push失败",!0),loadhide()}})}))}function postopen(i){loadshow();var s=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),a=!1;s.postindex[i].link&&(a=!0);function t(e){loadhide();var t,n=Base64.decode(e),o=Base64.decode(s.postindex[i].title);t=a?s.postindex[i].link:s.postindex[i].date,e=s.postindex[i].tags,n=B.gt("PostContent","PostContentEnd",n).trim(),SC("content").value=dehtml(n),SC("tag").value=e,SC("title").value=o,SC("date").value=t,addshow(),editpost=i}var n="post-"+i+".html";a&&(n=s.postindex[i].link+".html"),window.htmls[n]?t(window.htmls[n]):blog.getfileblob(window.accesstoken,window.githubrepo,blog.findfilesha(n),!0,{success:function(e){t(e.content),window.htmls[n]=e.content},failed:function(e){loadhide(),notice("加载文章失败"),notice("No such post.")}})}function addnew(){addhide(),editpost="none",SC("content").value="",SC("tag").value="",SC("title").value="",SC("date").value=""}function searchrender(e){var t,n="",o=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))).postindex;for(t in o){var i=Base64.decode(o[t].title).toLowerCase(),s=Base64.decode(o[t].intro).toLowerCase(),a=o[t].date.toLowerCase(),r=o[t].tags.toLowerCase();e=e.toLowerCase(),-1===i.indexOf(e)&&-1===s.indexOf(e)&&-1===a.indexOf(e)&&-1===r.indexOf(e)||(n+="<p class='scitemp'><a class='scitema' href='javascript:void(0);' onclick='postopen("+t+")'>"+i+"</a></p>")}""==n&&(n+="<h2>啥都没找到TAT</h2>"),n="<a class='closebtn' href='javascript:void(0);' onclick='sbrclose()'>×</a>"+n,SC("sbr").innerHTML=n}function sbrclose(){SC("sbr").style.zIndex=-1,SC("sbr").style.opacity=0,SC("sbr").innerHTML=""}function addshow(){SC("adbtn").style.display="block",setTimeout(function(){SC("adbtn").style.opacity=1},100)}function addhide(){SC("adbtn").style.opacity=0,setTimeout(function(){SC("adbtn").style.display="none"},1e3)}document.onkeydown=function(e){e=e||window.event;if(!e||13!=e.keyCode)return!0;e=SC("search").value;if(""===e||SC("search")!=document.activeElement)return!0;SC("sbr").style.zIndex=50,SC("sbr").style.opacity=1,SC("sbr").innerHTML="<p class='scitemp'><a class='scitema' href='#Searching..'>搜索中...</a></p>",searchrender(e)},SC("date").placeholder=getdate(),document.addEventListener("keydown",function(e){83==e.keyCode&&(navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&(e.preventDefault(),tempsave())});