/*ControlPosts2.1.4 - SomeBottle*/
var md=new showdown.Converter,editpost="none",tpjs=JSON.parse(window.tjson);window.mainjson?(renderlist(),loadhide()):(loadshow(),blog.getfile(window.accesstoken,window.githubrepo,tpjs.mainjson,!0,{success:function(a){console.log("ok");window.mainjson=a;renderlist();loadhide()},failed:function(a){loadhide();errshow()}}));var choose=0,timer;function rmj(){return"main."+Math.random().toString(36).substr(5)+".json"}function getdate(){var a=new Date,b=a.getMonth()+1,c=a.getDate();1<=b&&9>=b&&(b="0"+b);1<=c&&9>=c&&(c="0"+c);return a.getFullYear()+b.toString()+c.toString()}var B={r:function(a,b,c,e,d){e=void 0===e?!1:e;d=void 0===d?!0:d;if(a){if(e)return"("==e?a.replace(new RegExp("\\{\\("+b+"\\)\\}",(d?"g":"")+"i"),c):a.replace(new RegExp("\\{\\["+b+"\\]\\}",(d?"g":"")+"i"),c);if(d)for(;-1!==a.indexOf(b);)a=a.replace(b,c);else a=a.replace(b,c)}return a},gt:function(a,b,c,e){c=void 0===c?!1:c;e=void 0===e?!1:e;c=c?c:document.getElementsByTagName("html")[0].innerHTML;try{var d=e?c.split(a)[1]:c.split(new RegExp("\\{\\("+a+"\\)\\}","i"))[1];return e?d.split(b)[0]:d.split(new RegExp("\\{\\("+b+"\\)\\}","i"))[0]}catch(g){return!1}}};function renderlist(){var a=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),b="",c=0,e;for(e in a.dateindex){if(8<=c)break;var d=parseInt(e.replace("post","")),g=Base64.decode(a.postindex[d].title),b=b+("\x3cp class\x3d'postitemp'\x3e\x3ca class\x3d'postitema' href\x3d'javascript:void(0);' onclick\x3d'postopen("+d+")'\x3e"+g+"\x3c/a\x3e\x3c/p\x3e"),c=c+1}""==b&&(b+="\x3cp class\x3d'postitemp'\x3e\x3ca class\x3d'postitema' href\x3d'javascript:void(0);'\x3e\u8fd8\u6ca1\u6709\u6587\u7ae0\u5462\x3c/a\x3e\x3c/p\x3e");SC("rp").innerHTML=b}function eswitch(){choose+=1;7<=choose&&(choose=7);5==choose?SC("fbtn").style.backgroundColor="#FA5858":SC("fbtn").style.backgroundColor="#0080ff";SC("fbtn").innerHTML="\u7f16\u8f91/\u53d1\u5e03 \u9884\u89c8 \u4fdd\u5b58\u8349\u7a3f \u8bfb\u53d6\u8349\u7a3f \u5220\u9664 \u751f\u6210\u5f52\u6863 \u53d6\u6d88".split(" ")[choose-1];clearTimeout(timer);timer=setTimeout(function(){switch(choose){case 1:edit();console.log("\u7f16\u8f91/\u53d1\u5e03");break;case 2:console.log("\u9884\u89c8");preview();break;case 3:console.log("\u4fdd\u5b58\u8349\u7a3f");tempsave();break;case 4:console.log("\u8bfb\u53d6\u8349\u7a3f");readsave();break;case 5:console.log("\u5220\u9664");"none"==editpost?notice("\u73b0\u5728\u6ca1\u6709\u7f16\u8f91\u4efb\u4f55\u6587\u7ae0"):confirm("\u771f\u7684\u8981\u5220\u9664\u5f53\u524d\u6587\u7ae0\u5417\uff1f\uff01")&&delpost(editpost);break;case 6:console.log("\u751f\u6210\u5f52\u6863");tagarchive();break;case 7:console.log("\u53d6\u6d88")}SC("fbtn").innerHTML="O_o?";SC("fbtn").style.backgroundColor="#0080ff";choose=0},1E3)}function scriptcutter(a){var b=document.createElement("div");b.innerHTML=a;a=b.getElementsByTagName("script");for(var c in a){var e=a[c].innerHTML;void 0!==e&&(e=B.r(e,"/*",""),e=B.r(e,"*/",""),prc="/*"+e+"*/",a[c].innerHTML=prc)}return b.innerHTML}function rnspace(a){a=a.replace(/\r\n/g,"{{rn}}");a=a.replace(/\n/g,"{{n}}");return a=a.replace(/\s/g,"{{s}}")}function unrnspace(a){a=a.replace(/{{s}}/g," ");a=a.replace(/{{rn}}/g,"\r\n");return a=a.replace(/{{n}}/g,"\n")}function enhtml(a){return a.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26gt;").replace(/"/g,"\x26quot;").replace(/'/g,"\x26#039;")}function dehtml(a){return a.replace(/&amp;/g,"\x26").replace(/&lt;/g,"\x3c").replace(/&gt;/g,"\x3e").replace(/&nbsp;/g," ").replace(/&#039;/g,"'").replace(/&quot;/g,'"')}function tagarchive(){var a=tpjs.templatehtmls.tags,b=tpjs.templatehtmls.archives,c=tpjs.generatehtmls.tags,e=tpjs.generatehtmls.archives,d=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),g=window.htmls["index.html"],k=B.r(g,"title","Tags",!0),k=B.r(k,"sitename",d.name,!0),k=B.r(k,"keywords",d.name+",tag",!0),k=B.r(k,"description","Tag Page",!0),a=B.r(k,"type",a,!0),g=B.r(g,"title","Archives",!0),g=B.r(g,"sitename",d.name,!0),d=B.r(g,"keywords",d.name+",archive",!0),d=B.r(d,"description","Archive Page",!0),f=B.r(d,"type",b,!0);confirm("\u786e\u5b9a\u8981\u751f\u6210\u6807\u7b7e\u548c\u5f52\u6863\u9875\u9762\uff1f")&&(loadshow(),blog.cr(window.accesstoken,window.githubrepo,c,"Generate Tag Page",a,{success:function(a){blog.cr(window.accesstoken,window.githubrepo,e,"Generate Archive Page",f,{success:function(a){notice("Successful:D");loadhide()},failed:function(a){notice("\u751f\u6210\u5931\u8d25",!0);loadhide()}})},failed:function(a){notice("\u751f\u6210\u5931\u8d25",!0);loadhide()}}))}function covercutter(a){for(;-1!==a.indexOf("\x3cifcover\x3e");){var b=B.gt("\x3cifcover\x3e","\x3c/ifcover\x3e",a,!0);a=B.r(a,"\x3cifcover\x3e"+b+"\x3c/ifcover\x3e","")}return a}function transdate(a){a=String(a);var b=a.slice(-4),c=b.slice(-2),e=b.substring(0,2);return a.replace(b,"")+"-"+e+"-"+c}function indexrenderer(a){var b=tpjs.templatehtmls.postlist,c=window.htmls["index.html"],e=window.htmls["postitem.html"],e=B.gt("PostItem","PostItemEnd",e),d=a.dateindex,g="",k=parseInt(a.posts_per_page),f=0,n;for(n in d)if(f<k){var h=n.replace("post",""),d=a.postindex[h];if(d.link)--f;else var l=B.r(e,"postitemtitle",Base64.decode(d.title),!0),l=B.r(l,"postitemintro",Base64.decode(d.intro)+"...",!0),l=B.r(l,"postitemdate",transdate(d.date),!0),l=B.r(l,"postitemtags",d.tags.replace(/,/g,"\u00b7"),!0),h=B.r(l,"postitemlink","post-"+h+".html",!0),h=d.cover?B.r(h,"postcover",d.cover,!0):covercutter(h),g=g+h;f+=1}else break;c=B.r(c,"title","",!0);c=B.r(c,"description","",!0);c=B.r(c,"keywords",a.name,!0);b=B.r(c,"type",b,!0);a=B.r(b,"sitename",a.name,!0);return B.r(a,"content",enhtml(rnspace(g)),!0)}function tempsave(){function a(a,b){var c=JSON.parse(localStorage[a]||"[]"),d={};d.v=b;d.t=new Date;10<=c.length&&c.shift();c.push(d);localStorage[a]=JSON.stringify(c)}var b=SC("title").value,c=SC("date").value,e=SC("tag").value,d=SC("content").value;a("otitle",b);a("odate",c);a("otag",e);a("ocontent",d);notice("\u4fdd\u5b58\u6210\u529f")}function readsave(){function a(a,b){b=void 0===b?!1:b;var c=JSON.parse(localStorage[a]||"[]");return 0<=parseInt(b)?c[b]||!1:c}var b="",c=a("otitle"),e;for(e in c)b+="\u5e8f\u53f7:"+e+" \u4fdd\u5b58\u65f6\u95f4:"+c[e].t+"\n";b=parseInt(prompt("\u8bf7\u8f93\u5165\u8981\u8bfb\u53d6\u7684\u8349\u7a3f\u5e8f\u53f7\n"+b+"\n\n\u8fd9\u4f1a\u8986\u76d6\u4f60\u76ee\u524d\u7684\u5185\u5bb9",""));(c=a("otitle",b))&&0<=b?(SC("title").value=c.v,SC("date").value=a("odate",b).v,SC("tag").value=a("otag",b).v,SC("content").value=a("ocontent",b).v):notice("\u65e0\u6b64\u8349\u7a3f")}function preview(){var a=SC("content").value;SC("sbr").style.zIndex=50;SC("sbr").style.opacity=1;SC("sbr").innerHTML="\x3ca class\x3d'closebtn' href\x3d'javascript:void(0);' onclick\x3d'sbrclose()'\x3e\u00d7\x3c/a\x3e\x3ch2\x3ePreview:\x3c/h2\x3e\x3cstyle\x3eimg{max-width:100%;}\x3c/style\x3e"+md.makeHtml(a)}function coverdrawer(){return B.gt("-[cover:","]-",SC("content").value,!0)}function edit(){window.editprogress="doing";var a=tpjs.templatehtmls.post,b=SC("title").value;if(b.match(/^[ ]+$/)||""==b)return notice("\u6807\u9898\u4e0d\u80fd\u4e3a\u7a7a\u54e6"),!1;var c=SC("date").value;if(c.match(/^[ ]+$/)||""==c)c=getdate();var e=SC("tag").value,d=scriptcutter(SC("content").value),g=!1;if(isNaN(c)){g=!0;if(-1!==tpjs.alltp.indexOf(c+".html"))return notice("\u94fe\u63a5\u540d\u4e0e\u6a21\u677f\u91cd\u590d\uff01"),notice("\u8bf7\u66f4\u6362"),!1;e=""}var k=md.makeHtml(d).replace(/<\/?.+?>/g,"").substring(0,100).replace(/[ ]/g,"").replace(/[\r\n]/g,"");70<=d.length&&(k+="...");if(confirm("\u771f\u7684\u8981\u53d1\u5e03\u561b\uff1f")){var f=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),n=B.r(window.htmls["index.html"],"title",b,!0),n=B.r(n,"date",c,!0),n=B.r(n,"tags",e,!0),d=B.r(n,"content",enhtml(rnspace(d)),!0),d=B.r(d,"description",k.replace(/<\/?.+?>/g,""),!0),d=B.r(d,"keywords",e+","+f.name,!0),a=B.r(d,"type",a,!0),a=B.r(a,"sitename",f.name,!0);"initialized"==f[0]&&delete f[0];f.postnum||(f.postnum=0);f.postindex||(f.postindex={});f.dateindex&&"object"===typeof f.dateindex||(f.dateindex={});var h=f.postnum,l="New post";"none"!==editpost?(h=editpost,l="Edit post"):f.postnum+=1;var p=B.r(a,"pid",h,!0),u="";g&&(u=c,c=getdate());f.dateindex["post"+h]=c+h.toString();var a=0,m;for(m in f.dateindex)d=f.dateindex[m].toString().length,d>a&&(a=d);for(m in f.dateindex)if(n=f.dateindex[m],d=n.toString().length,d<a){for(var v=m.replace("post","").toString(),q=a-d,w=0,x="";w<q;)x+=(0).toString(),w+=1;q=getdate().toString().length;q=n.toString().substring(0,q);d=n.toString().substring(d-v.length).toString().replace(v,x+v);f.dateindex[m]=parseInt(q+d)}m=[];for(var r in f.dateindex)m.push([r,parseInt(f.dateindex[r])]);f.dateindex={};m=m.sort(function(a,b){return a[1]-b[1]}).reverse();window.testarray=m;for(var z in m)r=m[z],f.dateindex[r[0]]=r[1];var t="";if("none"!==editpost&&!g&&f.postindex[h].link)return notice("\u4f60\u6b63\u5728\u7f16\u8f91\u9875\u9762"),notice("\u4e0d\u80fd\u8f6c\u4e3a\u6587\u7ae0"),!1;if("none"!==editpost&&g&&(t=f.postindex[h].link,!t))return notice("\u4f60\u6b63\u5728\u7f16\u8f91\u6587\u7ae0"),notice("\u4e0d\u80fd\u8f6c\u4e3a\u9875\u9762"),!1;f.postindex[h]={};f.postindex[h].title=Base64.encode(b);f.postindex[h].date=c;(b=coverdrawer())?(f.postindex[h].cover=b,"none"==b&&f.postindex[h].cover&&delete f.postindex[h].cover,p=B.r(p,"cover",b,!0)):p=B.r(p,"cover","none",!0);g&&(f.postindex[h].link=u);f.postindex[h].intro=Base64.encode(k);f.postindex[h].tags=e;loadshow();var y="post-"+h+".html";g&&(y=u+".html");var A=indexrenderer(f),C=tpjs.mainjson;tpjs.mainjson=rmj();(new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,y,l,p,{success:function(b){a(b)},failed:function(a){notice("\u7f16\u8f91/\u53d1\u5e03\u5931\u8d25",!0);loadhide()}})})).then(function(a){return new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,tpjs.mainjson,l,JSON.stringify(f),{success:function(b){a(b)},failed:function(a){notice("\u7d22\u5f15\u4e0a\u8f7d\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,"index.html",l,A,{success:function(b){a(b)},failed:function(a){notice("\u9996\u9875\u5237\u65b0\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,"template.json",l,JSON.stringify(tpjs),{success:function(b){a(b)},failed:function(a){notice("\u7d22\u5f15\u6a21\u677f\u66f4\u65b0\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.del(window.accesstoken,window.githubrepo,C,"Delete recent json",{success:function(b){a(b)},failed:function(a){notice("\u65e7\u7d22\u5f15\u79fb\u9664\u51fa\u9519",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){""!==t&&t!==u?blog.del(window.accesstoken,window.githubrepo,t+".html","Delete recent page",{success:function(b){a(b);window.editprogress="finish"},failed:function(a){notice("\u9875\u9762\u66f4\u65b0\u51fa\u9519",!0);loadhide()}}):window.editprogress="finish"})});window.mainjson.content=Base64.encode(JSON.stringify(f));var D=setInterval(function(){"finish"==window.editprogress&&(window.gstate=0,window.editprogress="",notice("\u7f16\u8f91/\u53d1\u5e03\u6210\u529f"),renderlist(),"none"!==editpost?window.htmls["post-"+editpost+".html"]=Base64.encode(p):postopen(h),loadhide(),clearInterval(D))},1500)}}function delpost(a){var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,"")));if(b.postindex[a]){var c=b.postindex[a],e=!1;c.link&&(e=!0);delete b.postindex[a];delete b.dateindex["post"+a];loadshow();var d="post-"+a+".html";e&&(d=c.link+".html");var g=indexrenderer(b),k=tpjs.mainjson;tpjs.mainjson=rmj();(new Promise(function(a,c){blog.del(window.accesstoken,window.githubrepo,d,"Delete post",{success:function(c){window.mainjson.content=Base64.encode(JSON.stringify(b));a(c)},failed:function(a){notice("\u5220\u9664\u5931\u8d25TAT",!0);loadhide()}})})).then(function(a){return new Promise(function(a,c){blog.cr(window.accesstoken,window.githubrepo,tpjs.mainjson,"Delete post",JSON.stringify(b),{success:function(b){a(b)},failed:function(a){notice("\u66f4\u65b0\u7d22\u5f15\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.del(window.accesstoken,window.githubrepo,k,"Delete recent JSON",{success:function(b){a(b)},failed:function(a){notice("\u5220\u9664\u65e7\u7d22\u5f15\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,"template.json","Update template",JSON.stringify(tpjs),{success:function(b){addnew();renderlist();a(b)},failed:function(a){notice("\u66f4\u65b0\u7d22\u5f15\u6a21\u677f\u5931\u8d25",!0);loadhide()}})})}).then(function(a){return new Promise(function(a,b){blog.cr(window.accesstoken,window.githubrepo,"index.html","Delete post",g,{success:function(a){loadhide();notice("\u5220\u9664\u6210\u529f")},failed:function(a){loadhide();notice("\u9996\u9875\u66f4\u65b0\u5931\u8d25",!0)}})})})}}function postopen(a){loadshow();var b=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))),c=!1;b.postindex[a].link&&(c=!0);this.loadpost=function(d){loadhide();var e=Base64.decode(d);d=Base64.decode(b.postindex[a].title);var f=c?b.postindex[a].link:b.postindex[a].date,g=b.postindex[a].tags,e=B.gt("PostContent","PostContentEnd",e).trim();SC("content").value=unrnspace(dehtml(e));SC("tag").value=g;SC("title").value=d;SC("date").value=f;addshow();editpost=a};var e="post-"+a+".html";c&&(e=b.postindex[a].link+".html");if(window.htmls[e])this.loadpost(window.htmls[e]);else{var d=this;blog.getfile(window.accesstoken,window.githubrepo,e,!0,{success:function(a){d.loadpost(a.content);window.htmls[e]=a.content},failed:function(a){loadhide();notice("\u52a0\u8f7d\u6587\u7ae0\u5931\u8d25");notice("No such post.")}})}}function addnew(){addhide();editpost="none";SC("content").value="";SC("tag").value="";SC("title").value="";SC("date").value=""}document.onkeydown=function(a){if((a=a||window.event)&&13==a.keyCode)if(a=SC("search").value,""!==a&&SC("search")==document.activeElement)SC("sbr").style.zIndex=50,SC("sbr").style.opacity=1,SC("sbr").innerHTML="\x3cp class\x3d'scitemp'\x3e\x3ca class\x3d'scitema' href\x3d'#Searching..'\x3e\u641c\u7d22\u4e2d...\x3c/a\x3e\x3c/p\x3e",searchrender(a);else return!0;else return!0};function searchrender(a){var b="",c=JSON.parse(Base64.decode(window.mainjson.content.replace(/[\r\n]/g,""))).postindex,e;for(e in c){var d=Base64.decode(c[e].title).toLowerCase(),g=Base64.decode(c[e].intro).toLowerCase(),k=c[e].date.toLowerCase(),f=c[e].tags.toLowerCase();a=a.toLowerCase();if(-1!==d.indexOf(a)||-1!==g.indexOf(a)||-1!==k.indexOf(a)||-1!==f.indexOf(a))b+="\x3cp class\x3d'scitemp'\x3e\x3ca class\x3d'scitema' href\x3d'javascript:void(0);' onclick\x3d'postopen("+e+")'\x3e"+d+"\x3c/a\x3e\x3c/p\x3e"}""==b&&(b+="\x3ch2\x3e\u5565\u90fd\u6ca1\u627e\u5230TAT\x3c/h2\x3e");b="\x3ca class\x3d'closebtn' href\x3d'javascript:void(0);' onclick\x3d'sbrclose()'\x3e\u00d7\x3c/a\x3e"+b;SC("sbr").innerHTML=b}function sbrclose(){SC("sbr").style.zIndex=-1;SC("sbr").style.opacity=0;SC("sbr").innerHTML=""}function addshow(){SC("adbtn").style.display="block";setTimeout(function(){SC("adbtn").style.opacity=1},100)}function addhide(){SC("adbtn").style.opacity=0;setTimeout(function(){SC("adbtn").style.display="none"},1E3)}SC("date").placeholder=getdate();